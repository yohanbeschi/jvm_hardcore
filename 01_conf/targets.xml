<project name="targets" basedir="../" xmlns:plume="http://blog.soat.fr/ant-macros">
	<import file="properties.xml" />
	<import file="macros.xml" />
	<description>Common targets</description>
	
	<!--+=========================================================================================+-->
  <!--+ Classpath                                                                               +-->
	<!--+=========================================================================================+-->
	<!-- To compile main -->
  <path id="compile.classpath">
    <fileset dir="${libs.dir}">
      <include name="junit-4.10.jar" />
			<include name="pjba.jar" />
    </fileset>
  </path>
  
	<path id="assembler.execute.classpath">
		<path refid="compile.classpath"/>
		<pathelement location="${build.assembler.classes.dir}" />
  </path>
	
  <!-- To compile the tests -->
  <path id="test.compile.classpath">
		<path refid="compile.classpath"/>
		<pathelement location="${build.classes.dir}" />
		<pathelement location="${build.pjb-classes.dir}" />
  </path>
  
  <!-- To run the tests -->
  <path id="test.classpath">
		<path refid="test.compile.classpath"/>
		<pathelement location="${build.test-classes.dir}" />
  </path>

	<!--+=========================================================================================+-->
  <!--+ Targets                                                                                 +-->
	<!--+=========================================================================================+-->
	<target name="nop" description="Checks projects build">
		<echo>in ${basedir}</echo>
	</target>
	
	<!--+=========================================================================================+-->
  <!--+ Clean                                                                                   +-->
	<!--+=========================================================================================+-->
  <target name="clean" description="Removes directory: 02_build">
    <delete dir="${build.dir}" />
  </target>
  
  <target name="clean-dist" description="Removes directory: 03_dist">
    <delete dir="${dist.dir}" />
  </target>
  
  <target name="clean-test" 
	        description="Removes directories: 02_build/[test-classes &amp; junit-data &amp; junit-reports]">
    <delete dir="${build.test-classes.dir}" />
    <delete dir="${build.junit-data.dir}" />
		<delete dir="${build.junit-reports.dir}" />
  </target>
	
  <target name="clean-all" 
	        depends="clean, clean-dist" 
	        description="Removes directories: 04_build &amp; 03_dist" />
  
	<!--+=========================================================================================+-->
  <!--+ Init (private)                                                                          +-->
	<!--+=========================================================================================+-->
  <target name="-init-build">
    <mkdir dir="${build.classes.dir}" />
  </target>
  
  <target name="-init-dist">
    <mkdir dir="${dist.dir}" />
  </target>
  
  <target name="-init-test" depends="-check-test-compile, clean-test" if="test-compile.ok">
    <mkdir dir="${build.test-classes.dir}" />
		<mkdir dir="${build.junit-data.dir}" />
		<mkdir dir="${build.junit-reports.dir}" />
  </target>
	
	<target name="-init-assembler" depends="-check-assemble, clean" if="assemble.ok">
    <mkdir dir="${build.assembler.classes.dir}" />
		<mkdir dir="${build.assembler.reports.dir}" />
  </target>
  
	<!--+=========================================================================================+-->
  <!--+ Compile                                                                                 +-->
	<!--+=========================================================================================+-->	
	<!-- Main -->
	<target name="-check-compile">
	  <available type="dir" file="${src.main.java.dir}" property="compile.ok" />
	</target>
  <target name="compile" depends="-init-build, -check-compile" description="Compiles Main" if="compile.ok">
    <javac srcdir="${src.main.java.dir}" 
	       destdir="${build.classes.dir}" 
				 includeAntRuntime="false"
				 source="${javac.version}"
				 target="${javac.version}"
				 encoding="utf-8"
				 deprecation="true" />
  </target>
  
	<!-- Assembler/PJB -->
	<target name="-check-assemble">
	  <available type="dir" file="${src.main.assembler.dir}" property="assemble.ok" />
	</target>
	<target name="assemble" depends="-init-assembler, -check-assemble" description="Assemble pjb files" if="assemble.ok">
		<javac srcdir="${src.main.assembler.dir}" 
					 destdir="${build.assembler.classes.dir}" 
					 includeAntRuntime="false"
					 source="${javac.version}"
					 target="${javac.version}"
					 encoding="utf-8"
					 deprecation="true">
			<classpath refid="compile.classpath" />
		</javac>
		
		<copy todir="${build.assembler.classes.dir}">
			<fileset dir="${src.main.dir}">
        <include name="pjb/" />
			</fileset>
		</copy>
		
    <junit printsummary="true" haltonfailure="false" 
		       errorProperty="test.failed" failureProperty="test.failed">
			<classpath refid="assembler.execute.classpath"/>
			
			<formatter type="brief" usefile="false"/>
			<formatter type="plain" />
			<formatter type="xml"/>
			
			<batchtest todir="${build.assembler.reports.dir}">
				<fileset dir="${build.assembler.classes.dir}">
					 <include name="**/*.class" />
				</fileset>
			</batchtest>
		</junit>
		
		<junitreport todir="${build.assembler.reports.dir}">
			<fileset dir="${build.assembler.reports.dir}">
				<include name="TEST-*.xml"/>
			</fileset>
			<report format="frames" todir="${build.assembler.reports.dir}"/>
		</junitreport>
		
		<fail if="test.failed">
			Tests failed. Check ${build.assembler.reports.dir}
		</fail>
  </target>
	
  <!-- Test -->
	<target name="-check-test-compile">
	  <available type="dir" file="${src.test.java.dir}" property="test-compile.ok" />
	</target>
  <target name="test-compile" depends="-init-test, -check-test-compile, compile" description="Compiles Test" if="test-compile.ok">
		<javac srcdir="${src.test.java.dir}" 
					 destdir="${build.test-classes.dir}" 
					 includeAntRuntime="false"
					 source="${javac.version}"
					 target="${javac.version}"
					 encoding="utf-8"
					 deprecation="true">
			<classpath refid="test.compile.classpath" />
		</javac>
  </target>
	
	<!--+=========================================================================================+-->
  <!--+ Test                                                                                    +-->
	<!--+=========================================================================================+-->
  <target name="test" depends="test-compile" description="Executes Unit Tests">
		<junit printsummary="true" haltonfailure="false" 
		       errorProperty="test.failed" failureProperty="test.failed">
			<classpath refid="test.classpath"/>
			
			<formatter type="brief" usefile="false"/>
			<formatter type="plain" />
			<formatter type="xml"/>
			
			<test todir="${build.junit-data.dir}" name="${testClass}" 
						if="testClass" unless="testMethod" />
			
			<test todir="${build.junit-data.dir}" name="${testClass}" 
						if="testMethod" methods="${testMethod}" />
			
			<batchtest todir="${build.junit-data.dir}" unless="testClass">
				<fileset dir="${build.test-classes.dir}" />
			</batchtest>
		</junit>
		
		<junitreport todir="${build.junit-data.dir}">
			<fileset dir="${build.junit-data.dir}">
				<include name="TEST-*.xml"/>
			</fileset>
			<report format="frames" todir="${build.junit-reports.dir}"/>
		</junitreport>
		
		<fail if="test.failed">
			Tests failed. Check ${build.junit-reports.dir}
		</fail>
  </target>
  
	<!--+=========================================================================================+-->
  <!--+ Archive                                                                                 +-->
	<!--+=========================================================================================+-->
  <target name="archive" depends="compile, -init-dist, test" description="Creates a JAR file">
		<plume:jarlib jarName="${dist.dir}/${ant.project.name}" srcDir="${build.classes.dir}" />
  </target>

</project>

